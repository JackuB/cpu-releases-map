name: Update CVE Data

on:
  schedule:
    # Oracle releases CPUs around the 17th of Jan/Apr/Jul/Oct
    - cron: "0 6 18 1,4,7,10 *"   # Day after release
    - cron: "0 6 25 1,4,7,10 *"   # Catch Rev 2 updates
    - cron: "0 6 1 2,5,8,11 *"    # Following month safety net
  workflow_dispatch:
    inputs:
      only_recent:
        description: "Only scrape N most recent CPUs (0=all)"
        default: "0"
      skip_cache:
        description: "Skip HTTP cache"
        default: false
        type: boolean

permissions:
  contents: write

jobs:
  scrape:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Restore HTML cache
        uses: actions/cache@v4
        with:
          path: cache/
          key: cpu-html-cache-${{ github.run_id }}
          restore-keys: |
            cpu-html-cache-

      - name: Run scraper
        run: |
          ARGS="--verbose"
          if [ "${{ inputs.only_recent }}" != "0" ] && [ -n "${{ inputs.only_recent }}" ]; then
            ARGS="$ARGS --only-recent ${{ inputs.only_recent }}"
          fi
          if [ "${{ inputs.skip_cache }}" = "true" ]; then
            ARGS="$ARGS --no-cache"
          fi
          python -m src.main $ARGS

      - name: Check for changes
        id: diff
        run: |
          if git diff --quiet data/; then
            echo "changed=false" >> "$GITHUB_OUTPUT"
          else
            echo "changed=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Commit and push
        if: steps.diff.outputs.changed == 'true'
        run: |
          CVE_COUNT=$(wc -l < data/cves.txt | tr -d ' ')
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add data/
          git commit -m "Update CVE data: ${CVE_COUNT} unique CVEs ($(date -u +%Y-%m-%d))"
          git push

      - name: Job summary
        if: always()
        run: |
          if [ -f data/summary.md ]; then
            cat data/summary.md >> "$GITHUB_STEP_SUMMARY"
          else
            echo "Scraper did not produce summary output." >> "$GITHUB_STEP_SUMMARY"
          fi
